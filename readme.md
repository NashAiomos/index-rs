# 区块链交易索引服务

这是一个用于同步和索引区块链交易的Rust应用程序，专门设计用于与Internet Computer (IC) Ledger Canister进行交互。

## 核心功能

- 从区块链同步所有交易数据到MongoDB数据库
- 根据交易计算每个账户的余额
- 提供账户余额查询API
- 支持重置和完全重新同步模式
- 实时监控新交易

## 余额计算逻辑

余额计算采用了两阶段处理方式，确保了计算的准确性：

1. **第一阶段：仅同步交易数据到数据库**
   - 先同步所有归档交易
   - 再同步主账本交易
   - 这一阶段不做余额计算，只保存交易数据

2. **第二阶段：按索引顺序计算余额**
   - 从数据库读取所有交易
   - 按交易索引进行全局排序
   - 按顺序处理每笔交易并更新账户余额

余额计算规则：
- `transfer`: 从发送方减少余额，接收方增加余额，发送方扣除手续费
- `mint`: 接收方余额增加
- `burn`: 发送方余额减少
- `approve`: 不影响余额，但如果有手续费，从发送方扣除

## 运行方式

### 常规运行
```
cargo run
```

### 重置模式
```
cargo run -- --reset
```
重置模式会清空现有数据库，重新从区块链拉取所有交易，并重新计算余额。

## 配置

配置文件 `config.toml` 支持以下参数：
```toml
mongodb_url = "mongodb://localhost:27017"
database = "ledger"
ic_url = "https://icp0.io"
ledger_canister_id = "your-canister-id"
token_decimals = 8  # 可选，如果不设置会自动从canister查询
```

## 交易同步流程

1. 查找所有归档交易
2. 按区块范围排序处理归档
3. 每个归档按批次获取交易
4. 同步主账本最新交易
5. 完成所有交易获取后，进行余额计算
6. 进入定时监控模式，持续获取新交易

## 项目结构

```
src/
├── main.rs             # 主程序入口
├── config.rs           # 配置加载和处理
├── models.rs           # 数据模型定义
├── utils.rs            # 工具函数集合
├── blockchain.rs       # 区块链交互功能
├── db/
│   ├── mod.rs          # 数据库模块入口
│   ├── transactions.rs # 交易数据操作
│   ├── accounts.rs     # 账户数据操作
│   ├── balances.rs     # 余额数据操作
├── sync/
│   ├── mod.rs          # 同步模块入口
│   ├── ledger.rs       # 主账本同步
│   ├── archive.rs      # 归档同步
│   ├── admin.rs        # 管理员功能(包含reset)
```

## 数据库集合

程序维护三个主要集合：

1. **transactions**: 存储所有交易记录
2. **accounts**: 记录账户与交易的关系
3. **balances**: 存储每个账户的最新余额信息

## 构建与运行

1. **安装依赖**

   确保已安装 Rust 工具链及 MongoDB 数据库。

2. **构建项目**

   ```bash
   cargo build --release
   ```

3. **启动 MongoDB**

4. **运行项目**

   ```bash
   cargo run
   ```

5. **重置数据库并重新同步所有交易**

   如果需要忽略现有数据库内容，完全重新同步所有交易数据：

   ```bash
   cargo run -- --reset
   ```

## 功能特性

1. **代币小数位自动识别**
   
   程序会自动查询账本 Canister 的 `icrc1_decimals` 方法，获取代币小数位，使余额显示更准确。

2. **归档同步**
   
   程序会先从主账本 Canister 获取归档信息，然后顺序处理每个归档 Canister 中的历史交易。

3. **主账本同步**
   
   完成归档同步后，从主账本 Canister 获取最新交易，保持数据库与链上状态一致。

4. **实时余额计算**
   
   针对每笔交易，程序会实时更新相关账户的余额状态，支持转账、铸币、销毁和授权等操作。

5. **定时增量同步**
   
   每 5 秒自动检查一次主账本是否有新交易，并同步到数据库中。

6. **丰富的日志信息**
   
   程序运行过程中记录详细的日志，便于追踪同步进度和问题诊断。

## 管理员功能

1. **数据库重置**
   
   通过 `--reset` 参数触发完整重置和重新同步，仅限管理员使用。
   
   ```bash
   cargo run -- --reset
   ```
   
2. **错误恢复**
   
   即使遇到错误，程序也会尝试自动恢复和继续同步，确保数据完整性。
