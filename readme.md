# index-rs

`index-rs` 是一个用于同步和索引 Internet Computer (IC) 账本 Canister 交易的 Rust 工具。

它会每秒拉取主账本及归档 Canister 的所有交易，然后按账户分组存储到 MongoDB 数据库中，便于后续查询和分析。同时，还会自动计算和更新每个账户的实时余额。

## 数据库集合

程序维护三个主要集合：

1. **transactions**: 存储所有交易记录
2. **accounts**: 记录账户与交易的关系
3. **balances**: 存储每个账户的最新余额信息

## 构建与运行

1. **安装依赖**

   ```bash
   cargo build
   ```

2. **启动 MongoDB**

   默认连接 `mongodb://localhost:27017`，数据库名 `ledger_sync`。

   启动数据库：

   ```bash
   net start MongoDB
   ```

   关闭数据库：

   ```bash
   net stop MongoDB
   ```

3. **运行项目**

   ```bash
   cargo run
   ```

4. **重置数据库并重新同步所有交易**

   如果需要忽略现有数据库内容，完全重新同步所有交易数据：

   ```bash
   cargo run -- --reset
   ```

   这个命令将会:
   - 清空数据库中现有的所有交易和账户-交易关系记录
   - 从区块链上的第一笔交易开始重新同步所有交易数据
   - 包括所有归档 canister 和主 ledger canister 中的交易

## 功能特性

1. **初始化数据库和网络连接**

   连接本地 MongoDB，准备三个集合：transactions（交易详情）、accounts（账户-交易关系）和balances（账户余额）。

   为各个集合创建索引，提高查询效率。

   初始化 IC 网络代理（Agent），指定主 Ledger Canister 的 ID 。

2. **获取归档信息**

   调用主 Ledger Canister 的 archives 方法，获取所有归档 Canister 的信息（每个归档包含其 canister_id 及区块范围）。

   如果没有归档信息，直接退出。

3. **同步归档 Canister 的历史交易**

   选取第一个归档 canister，获取其区块范围。

   先尝试获取一笔交易，测试解码是否成功（兼容多种可能的数据结构）。

   如果能成功解码，按批次（ARCHIVE_BATCH_SIZE=2000）循环获取归档区块范围内的所有交易：

   每批获取后，保存到 transactions 集合。

   对每笔交易，提取相关账户，更新 accounts 集合，记录账户与交易索引的关系。

4. **同步主 Ledger Canister 的新交易**

   查询本地数据库中已同步的最大交易索引，从下一个索引开始增量同步。

   每次批量获取新交易，处理它们并更新三个集合。

   如果遇到错误，最多重试 3 次。

5. **定时增量同步**

   初始同步完成后，进入循环，每隔 5 秒自动增量同步主 Ledger Canister 的新交易，保持本地数据库与链上数据实时同步。

6. **数据库完全重置与重新同步**

   使用 `--reset` 参数时，会清空数据库中所有现有数据，并从区块链上的第一笔交易开始重新同步所有交易。

7. **实时余额跟踪**

   在处理每笔交易时，系统会根据交易类型和金额实时更新相关账户的余额：
   - 转账交易：发送方余额减少，接收方余额增加
   - 铸币交易：接收方余额增加
   - 销毁交易：发送方余额减少

   可以通过查询balances集合获取任意账户的最新余额。

8. **辅助功能**

   支持多种交易结构的解码，兼容不同版本的 canister 。

   提供按账户查询交易、获取账户余额等便捷接口。

**流程**：初始化 → 2. 获取归档信息 → 3. 同步归档历史交易 → 4. 同步主账本新交易 → 5. 定时增量同步
